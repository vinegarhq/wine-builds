From 610c9ee2e216face93d37ebdb1e4d5fe986f1546 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Tue, 9 Dec 2025 07:54:10 +0100
Subject: [PATCH 27/48] win32u: Iterate the client surfaces rather than the
 toplevel window tree.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=59089
Signed-off-by: sewn <sewn@disroot.org>
---
 dlls/win32u/window.c | 16 ++--------------
 1 file changed, 2 insertions(+), 14 deletions(-)

diff --git a/dlls/win32u/window.c b/dlls/win32u/window.c
index ebd66cc8d29..d3c6da11bdb 100644
--- a/dlls/win32u/window.c
+++ b/dlls/win32u/window.c
@@ -310,7 +310,7 @@ static void update_client_surfaces( HWND hwnd )
 
     LIST_FOR_EACH_ENTRY_SAFE( surface, next, &client_surfaces, struct client_surface, entry )
     {
-        if (surface->hwnd != hwnd) continue;
+        if (NtUserGetAncestor( surface->hwnd, GA_ROOT ) != hwnd) continue;
         surface->funcs->update( surface );
         InterlockedExchange( &surface->updated, 1 );
     }
@@ -2133,18 +2133,6 @@ static struct window_surface *get_window_surface( HWND hwnd, UINT swp_flags, BOO
     return new_surface;
 }
 
-static void update_window_client_surfaces( HWND hwnd )
-{
-    HWND *children;
-    int i;
-
-    update_client_surfaces( hwnd );
-
-    if (!(children = list_window_children( hwnd ))) return;
-    for (i = 0; children[i]; i++) update_window_client_surfaces( children[i] );
-    free( children );
-}
-
 static HICON get_icon_info( HICON icon, ICONINFO *ii )
 {
     return icon && NtUserGetIconInfo( icon, ii, NULL, NULL, NULL, 0 ) ? icon : NULL;
@@ -2348,7 +2336,7 @@ static BOOL apply_window_pos( HWND hwnd, HWND insert_after, UINT swp_flags, stru
 
         user_driver->pWindowPosChanged( hwnd, insert_after, owner_hint, swp_flags, &monitor_rects,
                                         get_driver_window_surface( new_surface, raw_dpi ) );
-        update_window_client_surfaces( toplevel );
+        update_client_surfaces( toplevel );
     }
 
     return ret;
-- 
2.52.0

